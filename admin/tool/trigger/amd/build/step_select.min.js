define(["jquery","core/str","core/modal_factory","core/modal_events","core/templates","core/ajax","core/fragment","core/notification"],function(a,b,c,d,e,f,g,h){function i(){var b=a("[name=stepjson]").val(),c=[];return""!==b&&(c=JSON.parse(b)),c}function j(b){a("[name=stepjson]").val(JSON.stringify(b)),a("[name=isstepschanged]").val(1)}function k(){var a={},b={jsonformdata:JSON.stringify(a)};v.setBody(x),v.setBody(g.loadFragment("tool_trigger","new_base_form",u,b))}function l(b){var c=b.map(function(a,b){return{name:a.name,typedesc:a.typedesc,stepdesc:a.stepdesc,steporder:b}}),d={rows:c};e.render("tool_trigger/workflow_steps",d).then(function(b){a("#steps-table").html(b),t()}).fail(function(){h.exception({message:"Error updating steps table"})})}function m(b){b.preventDefault();var c=v.getRoot().find("form"),d=c.serializeArray().reduce(function(a,b){return"sesskey"===b.name||b.name.startsWith("_qf__")||(a[b.name]=b.value),a},{});d.stepdesc=a("[name=stepclass] option:selected").text(),d.typedesc=a("[name=type] option:selected").text(),f.call([{methodname:"tool_trigger_validate_form",args:{stepclass:d.stepclass,jsonformdata:JSON.stringify(c.serialize())}}])[0].done(function(){var a=i();d.steporder>=0?a[d.steporder]=d:(a.push(d),d.steporder=a.length-1),j(a),l(a),v.hide()}).fail(function(){q(d.type,d.stepclass,"",c.serialize())})}function n(b){a("[name=stepclass]").empty().append(a("<option>",{value:"",text:"Choose..."})),a.each(b,function(b,c){a("[name=stepclass]").append(a("<option>",{value:c["class"],text:c.name}))})}function o(a){f.call([{methodname:"tool_trigger_step_by_type",args:{steptype:a}}])[0].done(function(a){n(a)})}function p(){var b=a("[name=eventtomonitor]").val();return b}function q(a,b,c,d,e){void 0===c&&(c=""),void 0===d&&(d=""),void 0===e&&(e=0),v.setBody(x),v.setBody(g.loadFragment("tool_trigger","new_step_form",u,{steptype:a,stepclass:b,defaults:JSON.stringify(c),ajaxformdata:d,event:p(),existingsteps:JSON.stringify(i()),steporder:e}))}function r(){a("body").on("change","[name=type]",function(){o(this.value)}),a("body").on("change","[name=stepclass]",function(){var b=a("[name=type]").val(),c=this.value;q(b,c,"","",-1)})}function s(b,c,d){var e=400,f=b[c],g=b[d];f.steporder=d,g.steporder=d,b[c]=g,b[d]=f;var h=a("tr.tool-trigger-step-table-row"),i=h.eq(c),k=h.eq(d),m=i.height(),n=k.height(),o=i.find("th").css("background-color"),p=k.find("th").css("background-color");a([i,k]).each(function(a,b){b[0].style.position="relative",b[0].style.top="0",b[0].style.transition="top "+e+"ms",b.find("th,td").each(function(a,b){b.style.transition="background-color "+e+"ms"})}),window.setTimeout(function(){i[0].style.top=n+"px",i.find("td,th").each(function(a,b){b.style.backgroundColor=p}),k[0].style.top=-1*m+"px",k.find("td,th").each(function(a,b){b.style.backgroundColor=o})}),i.find(".tool-trigger-step-movedown").fadeTo(e,.1),k.find(".tool-trigger-step-moveup").fadeTo(e,.1).promise().always(function(){j(b),l(b)})}function t(){a(".tool-trigger-step-moveup").slice(1).removeClass("tool-trigger-initial-hidden").on("click",function(){var b=i(),c=a(this).data("steporder");return 0===c||(s(b,c-1,c),!0)}),a(".tool-trigger-step-movedown").slice(0,-1).removeClass("tool-trigger-initial-hidden").on("click",function(){var b=i(),c=a(this).data("steporder");return c>=b.length-1||(s(b,c,c+1),!0)}),a(".tool-trigger-step-edit").removeClass("tool-trigger-initial-hidden").on("click",function(){v.setBody(x),v.show();var b=i(),c=a(this).data("steporder"),d=b[c];q(d.type,d.stepclass,d,void 0,c)}),a(".tool-trigger-step-delete").removeClass("tool-trigger-initial-hidden").on("click",function(){var b=i(),c=a(this).data("steporder");return b.splice(c,1),c<=b.length&&b.slice(c).forEach(function(a){a.steporder=a.steporder-1}),j(b),a(this).closest("tr").fadeOut(function(){l(b)}),!0})}var u,v,w={},x='<p class="text-center"><i class="fa fa-spinner fa-pulse fa-2x fa-fw"></i><span class="sr-only">Loading...</span></p>';return w.init=function(e){u=e,b.get_string("modaltitle","tool_trigger").then(function(b){c.create({type:c.types.SAVE_CANCEL,title:b,body:x,large:!0},a("#id_stepmodalbutton")).done(function(a){v=a,v.getRoot().on(d.save,m),v.getRoot().on(d.hidden,k),r(),k()})}),t()},w});