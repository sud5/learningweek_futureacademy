define(["jquery","core/log","core/ajax","core/str","core/templates","core/notification","theme_snap/util","theme_snap/ajax_notification","theme_snap/footer_alert","core/event","core/fragment"],function(a,b,c,d,e,f,g,h,i,j,k){var l,m,n=this,o=[],p=!1,q=[],r=null,s=null,t=function(){"weeks"!=n.courseConfig.format&&"topics"!=n.courseConfig.format||(a("#course-toc .chapter-title").click(function(b){var c=a(b.target),d=c.attr("href");"undefined"!=typeof d&&d.length>0&&y(d.split("#section-")[1],0)}),a("#toc-searchables li a").click(function(b){var c=a(b.target),d=c.attr("href").split("&"),e=d[0],f=d[1]||null;e=e.split("#section-")[1],y(e,f)}))},u=function(){"weeks"!=n.courseConfig.format&&"topics"!=n.courseConfig.format||(a(".section_footer .next_section, .section_footer .icon-arrow-right, .section_footer .previous_section, .section_footer .icon-arrow-left").click(function(b){var c=a(b.target),d=c.attr("section-number");"undefined"!=typeof d&&d.length>0&&y(d,0)}),a(".section_footer .text").click(function(b){var c=a(b.target),d=c.find(".nav_guide").attr("section-number");"undefined"!=typeof d&&d.length>0&&y(d,0)}))},v=function(b){a("#toc-search-results").html("");var c=a("#"+b.replace("#",""));g.scrollToElement(c);var d=a("#searchpin");d.length||(d=a('<i id="searchpin"></i>')),a(c).find(".instancename").prepend(d),a(c).attr("tabindex","-1").focus(),a("#course-toc").removeClass("state-visible")},w=function(){var b;if(1===o.length){var c=a(o[0]).find(".snap-asset-link .instancename").html();c=c||M.util.get_string("pluginname","label",c),b=M.util.get_string("moving","theme_snap",c)}else b=M.util.get_string("movingcount","theme_snap",o.length);i.setTitle(b)},x=function(b){"undefined"!=typeof o&&o.length>0&&(a(".section-drop").each(function(){var c=M.util.get_string("movingdropsectionhelp","theme_snap",{moving:b,before:a(this).data("title")});a(this).html(c)}),i.setSrNotice(M.util.get_string("movingstartedhelp","theme_snap",b)))},y=function(b,c){var d=a("#section-"+b);if(0==d.length&&q.indexOf(b)==-1){q.push(b);var e={courseid:n.courseConfig.id,section:b};a(".sk-fading-circle").show(),a(".course-content ."+n.courseConfig.format+' li[id^="section-"]').hide(),k.loadFragment("theme_snap","section",n.courseConfig.contextid,e).done(function(d,e){var f=a(d);z(b,f,c,e)})}},z=function(b,c,d,f){var g=a(".course-content ."+n.courseConfig.format),h=[];g.find("li[id^=section-]").each(function(){h.push(parseInt(a(this).attr("id").split("section-")[1]))});var i=a("<div></div>");e.replaceNodeContents(i,c,f),i.find(".snap-resource-long .contentafterlink .snap-resource-card-fadeout").each(function(){a(this).appendTo(a(this).prevAll(".snap-resource-long .contentafterlink .no-overflow"))}),i.find(".snap-header-card .snap-header-card-icons .disabled-snap-asset-completion-tracking").remove();var k=a("li.snap-activity.modtype_folder div.contentwithoutlink div.snap-assettype"),l=a("li.snap-activity.modtype_folder div.activityinstance div.snap-header-card");if(k.prependTo(l),a("li.snap-activity.modtype_folder #ygtvcontentel1 > div > span.fp-filename").each(function(){a(this).replaceWith("<h3>"+a(this).text()+"</h3>")}),h.length>0){var m=h.reduce(function(a,c){return Math.abs(c-b)<Math.abs(a-b)?c:a});m>b?g.find("#section-"+m).before(i.find('li[id^="section-"]')):g.find("#section-"+m).after(i.find('li[id^="section-"]'))}else a(".sk-fading-circle").after(i);a(".sk-fading-circle").hide(),j.notifyFilterContentUpdated(a(".course-content ."+n.courseConfig.format));var o=g.find('li[id^="section-"]');o.removeClass("state-visible");var p="#section-"+b;if(a(p).addClass("state-visible"),"top"==n.courseConfig.toctype&&"topics"==n.courseConfig.format&&b>0){var q=a(p).find(".sectionname").html(),r=a(".chapter-title"),s=0;a.each(r,function(c,d){a(d).attr("href").split("#section-")[1]==b&&(s=c)}),a(p).find(".sectionname").html(s+". "+q)}o.show(),a(p).find(".section_footer .next_section, .section_footer .icon-arrow-right, .section_footer .previous_section, .section_footer .icon-arrow-left").click(function(b){var c=a(b.target),d=c.attr("section-number");"undefined"!=typeof d&&d.length>0&&y(d,0)}),a(p).find(".section_footer .text").click(function(b){var c=a(b.target),d=c.find(".nav_guide").attr("section-number");"undefined"!=typeof d&&d.length>0&&y(d,0)}),a(p+" .section-modchooser-link").click(function(){var b=a(this).attr("data-section");a(".snap-modchooser-addlink").each(function(){var c=this.href.replace(/(section=)[0-9]+/gi,"$1"+b);a(this).attr("href",c)})}),0!=d&&"undefined"!=typeof d&&v(d);var t=a("#region-main .section-moving").find(".sectionname").text();"undefined"!=typeof t&&t.length>0&&x(t);var u=a("#region-main .section-moving").attr("id");"undefined"!=typeof u&&u.length>0&&a("#section-"+(parseInt(u.split("section-")[1])+1)+" .snap-drop.section-drop").removeClass("partial-render"),a("#course-toc #chapters li").removeClass("snap-visible-section"),a('#course-toc .chapter-title[href="#section-'+b+'"]').parent("li").addClass("snap-visible-section"),a(p).find("ul.section").append('<li class="snap-drop asset-drop"><div class="asset-wrapper"><a href="#">'+M.util.get_string("movehere","theme_snap")+"</a></div></li>")};return{init:function(j){n.courseConfig=j.courseConfig;var k=function(){var c={};this.start=function(d,e,f){return this.ajaxing(d)?(b.debug("Skipping ajax request for "+d+", AJAX already in progress"),!1):(M.util.js_pending(d),c[d]={trigger:e,subSelector:f},e&&(f?a(e).find(f).addClass("ajaxing"):a(e).addClass("ajaxing")),!0)},this.ajaxing=function(a){return M.util.pending_js.indexOf(a)>-1},this.complete=function(b){var d,e;c[b]&&(d=c[b].trigger,e=c[b].subSelector),d&&(e?a(d).find(e).removeClass("ajaxing"):a(d).removeClass("ajaxing")),delete c[b],M.util.js_complete(b)}};m=new k;var v=function(b){return n.courseConfig.partialrender?parseInt(a(b).attr("id").split("section-")[1]):parseInt(a(b).attr("id").replace("section-",""))},z=function(b){return v(a(b).parents("li.section.main")[0])},A=function(){a("body").removeClass("snap-move-inprogress"),a("body").removeClass("snap-move-section"),a("body").removeClass("snap-move-asset"),i.hideAndReset(),a(".section-moving").removeClass("section-moving"),a(".asset-moving").removeClass("asset-moving"),a(".snap-asset a").removeAttr("tabindex"),a(".snap-asset button").removeAttr("disabled"),a(".js-snap-asset-move").removeAttr("checked"),o=[],n.courseConfig.partialrender&&a(".snap-drop.section-drop").addClass("partial-render")},B=function(){var b=a(l).find(".instancename").html();i.removeAjaxLoading(),i.setTitle(M.util.get_string("movefailed","theme_snap",b)),window.setTimeout(function(){A(!1)},2e3)},C=function(a){var b=o.indexOf(a);b>-1&&o.splice(b,1),w()},D=function(c,d,e){if(p)return void b.debug("Skipping ajax request, one already in progress");i.addAjaxLoading(),c.sesskey=M.cfg.sesskey,c.courseId=j.courseConfig.id,c.field="move",b.debug("Making course/rest.php request",c);var f=a.ajax({type:"POST",async:!0,data:c,url:M.cfg.wwwroot+j.courseConfig.ajaxurl});f.done(function(a){h.ifErrorShowBestMsg(a).done(function(a){return a?(b.debug("Ajax request fail"),void B()):(b.debug("Ajax request successful"),d&&d(),e&&"resource"===c["class"]&&A(),void 0)})}),f.fail(function(){B()}),e&&f.always(function(){p=!1,i.removeAjaxLoading()})},E=function(b){return n.courseConfig.partialrender?a('#course-toc #chapters > li a[href="#section-'+b+'"]').text():a("#chapters li:nth-of-type("+(b+1)+") .chapter-title").html()},F=function(b){var c,d,f=a.Deferred();if(b){if(c=a(b),n.courseConfig.partialrender)var g=a("#course-toc #chapters > li a");else var g=a("#region-main .course-content > ul li.section");d=g.length}else b=n.courseConfig.partialrender?"#course-toc #chapters > li a":"#region-main .course-content > ul li.section",c=a(b),d=c.length;var h=0;return a.each(c,function(b,g){if(n.courseConfig.partialrender){var i,j=a(g).attr("href");i="undefined"!=typeof j&&j!==!1?parseInt(a(g).attr("href").split("#section-")[1]):parseInt(a(g).attr("id").split("section-")[1])}else var i=v(g);var k,l,m=i-1,o=i+1,p=!1,q=!1;m>-1&&(k=n.courseConfig.partialrender?a("#section-"+m).hasClass("draft"):a("#section-"+m).hasClass("hidden"),l=k?" dimmed_text":"",p={section:m,title:E(m),classes:l}),o<d&&(k=n.courseConfig.partialrender?a("#section-"+o).hasClass("draft"):a("#section-"+o).hasClass("hidden"),l=k?" dimmed_text":"",q={section:o,title:E(o),classes:l});var r={previous:p,next:q};e.render("theme_snap/course_section_navigation",r).done(function(b){var d=a("#section-"+i+" .section_footer");d.length>0&&d.replaceWith(b),h++,h===c.length&&f.resolve()})}),f.promise()},G=function(a,b,c){if(c>=a.length)for(var d=c-a.length+1;d--;)a.push(void 0);return a.splice(c,0,a.splice(b,1)[0]),a},H=function(b,c,d,e){if(j.courseConfig.partialrender){var f=[],g=[];if(0!=b&&0!=c){a.each(a("#course-toc #chapters > li a"),function(b,c){g.push(a(c).attr("href").split("#section-")[1])});var h=G(g,b,c)}else{g=d,d.splice(e,1);var h=d}a.each(a("#region-main .course-content > ul li.section"),function(b,c){var d=a(c).attr("id").split("section-")[1],e=h.indexOf(d),g=E(e);a(c).attr("id","section-"+e),"top"==n.courseConfig.toctype&&"topics"==n.courseConfig.format&&e>0&&(g=e+". "+g),a("#section-"+e+" .content .sectionname").html(g),f.push(e),a(c).find("a.section-modchooser-link").attr("data-section",e)}),q=f}else a.each(a("#region-main .course-content > ul li.section"),function(b,c){a(c).attr("id","section-"+b);var d=E(b);a("#section-"+b+" .content .sectionname").html(d),a(this).find("a.section-modchooser-link").attr("data-section",b)});F().done(function(){j.courseConfig.partialrender&&X()})},I=function(d,g){d.preventDefault();var k=z(g),l=a("#section-"+k),o=l.find(".sectionname").text(),p=function(){if(m.start("section_delete",g)){var d=M.util.get_string("deletingsection","theme_snap",o);i.setTitle(d),i.addAjaxLoading(""),i.show();var f={courseshortname:j.courseConfig.shortname,action:"delete",sectionnumber:k,value:1,loadmodules:!0};b.debug("Making course/rest.php section delete request",f);var p=c.call([{methodname:"theme_snap_course_sections",args:f}],!0,!0),q=[];a.each(a("#course-toc #chapters > li a"),function(b,c){q.push(a(c).attr("href").split("#section-")[1])}),p[0].done(function(b){e.render("theme_snap/course_toc",b.toc).done(function(b){if(a("#course-toc").html(a(b).html()),a(document).trigger("snapTOCReplaced"),l.remove(),H(0,0,q,k),n.courseConfig.partialrender){var c=a(".chapter-title"),d=[];a.each(c,function(b,c){d.push(a(c).attr("href").split("#section-")[1])});var e=d.reduce(function(a,b){return Math.abs(b-k)<Math.abs(a-k)?b:a});location.hash="section-"+e,1==a("li#section-"+e).length?j.showSection():y(e,0)}else k>=a(".course-content > ul li.section").length&&(location.hash="section-"+(k-1)),j.showSection();m.complete("section_delete")}).always(function(){i.hideAndReset()}).fail(function(){m.complete("section_delete")})}).fail(function(a){h.ifErrorShowBestMsg(a),i.hideAndReset(),m.complete("section_delete")})}},q=M.util.get_string("confirm","moodle"),r=M.util.get_string("confirmdeletesection","moodle",o),s=M.util.get_string("deletesectionconfirm","theme_snap"),t=M.util.get_string("cancel","moodle");f.confirm(q,r,s,t,p)},J=function(e,g){e.preventDefault();var j=a(a(g).parents(".snap-asset")[0]),k=Number(j[0].id.replace("module-","")),l=j.find(".instancename").text().trim(),n=a(g).data("action"),o="",p="",q="",t="",u="asset_"+n;if(!m.ajaxing(u)){var v=function(){if(m.start(u,j,".snap-edit-asset-more")){var d={action:n,sectionreturn:0,id:k};c.call([{methodname:"core_course_edit_module",args:d}],!0,!0)[0].done(function(c){h.ifErrorShowBestMsg(c,q,t).done(function(d){return m.complete(u),d?void b.debug("Ajax request fail"):(b.debug("Ajax request successful"),r=null,s=null,"delete"===n?(j.remove(),a('#toc-searchables li[data-id="'+k+'"]').remove()):"show"===n?j.removeClass("draft"):"hide"===n?j.addClass("draft"):"duplicate"===n&&j.replaceWith(c),void 0)})}).fail(function(a){h.ifErrorShowBestMsg(a,q,t).done(function(){m.complete(u)})}).always(function(){i.hideAndReset()})}},w=function(){return"duplicate"===n?(o="action:duplicateasset",p="error:failedtoduplicateasset"):"show"===n||"hide"===n?(o="action:changeassetvisibility",p="error:failedtochangeassetvisibility"):"delete"===n&&(o="action:deleteasset",p="error:failedtodeleteasset"),d.get_strings([{key:o,component:"theme_snap"},{key:p,component:"theme_snap"}])};w().then(function(a){if(q=a[0],t=a[0],"delete"===n){var b="",c={type:M.util.get_string("pluginname",j.attr("class").match(/modtype_([^\s]*)/)[1])};""!==l?(c.name=l,b=M.util.get_string("deletechecktypename","moodle",c)):b=M.util.get_string("deletechecktype","moodle",c);var d=M.util.get_string("confirm","moodle"),e=M.util.get_string("deleteassetconfirm","theme_snap",c.type),g=M.util.get_string("cancel","moodle");f.confirm(d,b,e,g,v)}else v()})}},K=function(c){var d={};b.debug("Move objects",o),d["class"]="resource",w(),l=o.shift(),d.id=Number(l.id.replace("module-","")),c&&!a(c).hasClass("snap-drop")?d.beforeId=Number(a(c)[0].id.replace("module-","")):d.beforeId=0,"page-site-index"===document.body.id?d.sectionId=1:c?d.sectionId=z(c):d.sectionId=z(l),o.length>0?D(d,function(){a(c).before(a(l)),K(c)},!1):D(d,function(){a(c).before(a(l))},!0)},L=function(b){var d=z(b),f=v(o[0]),g=f<d?d-1:d,i={"class":"section",id:f,value:g};D(i,function(){c.call([{methodname:"theme_snap_course_toc_chapters",args:{courseshortname:j.courseConfig.shortname},done:function(b){e.render("theme_snap/course_toc_chapters",b.chapters).done(function(b){a("#chapters").replaceWith(b),a("#section-"+d).before(a("#section-"+f)),H(f,g,[],null),location.hash="section-"+g,j.showSection(),A()})},fail:function(a){h.ifErrorShowBestMsg(a),A()}}],!0,!0)},!0)},N=function(){var b=".snap-asset-actions .js_snap_hide, ";b+=".snap-asset-actions .js_snap_show, ",b+=".snap-asset-actions .js_snap_delete, ",b+=".snap-asset-actions .js_snap_duplicate",a(document).on("click",b,function(a){J(a,this)})},O=function(b,d){a("#region-main").on("click",".snap-section-editing.actions .snap-"+b,function(f){f.stopPropagation(),f.preventDefault();var g=this,i=function(a){this.message="Invalid section action: "+a,this.name="invalidActionException"},k=["visibility","highlight"];if(k.indexOf(b)===-1)throw new i(b);if(m.start("section_"+b,g)){var l,o=!0;"visibility"===b?(l=a(this).hasClass("snap-hide")?0:1,r&&r.length>0&&s&&s.length>0&&(o=!1)):l="true"===a(this).attr("aria-pressed")?0:1;var p=z(this),q="#section-"+p+" .snap-section-editing",t=q+" .snap-"+b,u=c.call([{methodname:"theme_snap_course_sections",args:{courseshortname:j.courseConfig.shortname,action:b,sectionnumber:p,value:l,loadmodules:o}}],!0,!0);u[0].fail(function(a){var c,d;"visibility"===b?(c=M.util.get_string("error:failedtochangesectionvisibility","theme_snap"),d=M.util.get_string("action:changesectionvisibility","theme_snap")):(c=M.util.get_string("error:failedtohighlightsection","theme_snap"),d=M.util.get_string("action:highlightsectionvisibility","theme_snap")),h.ifErrorShowBestMsg(a,d,c).done(function(){m.complete("section_"+b)})}).always(function(){a(g).removeClass("ajaxing")}).done(function(c){return e.render("theme_snap/course_action_section",c.actionmodel).then(function(b){if(a(t).replaceWith(b),a(t).focus(),!o&&(r&&r.length>0&&0===c.toc.modules.length&&(c.toc.modules=r),s&&s.length>0)){var d=s.slice(0);a.each(c.toc.chapters.chapters,function(a){c.toc.chapters.chapters[a].progress=d.shift()})}return o&&(r=c.toc.modules,s=[],a.each(c.toc.chapters.chapters,function(a,b){s.push(b.progress)})),e.render("theme_snap/course_toc",c.toc)}).then(function(c){if(a("#course-toc").html(a(c).html()),a(document).trigger("snapTOCReplaced"),d&&"function"==typeof d){var e=d(p,l);n.courseConfig.partialrender?"function"==typeof d&&m.complete("section_"+b):e&&"function"==typeof e.always?e.always(function(){m.complete("section_"+b)}):m.complete("section_"+b)}else m.complete("section_"+b)})})}})},P=function(){O("highlight",function(b){a("#section-"+b).toggleClass("current");var c=a("li.section.main").not("#section-"+b).not("#section-0").removeClass("current");c.each(function(){var b=a(this).find(".snap-highlight"),c=z(b),d=a(b).attr("href").replace(/(marker=)[0-9]+/gi,"$1"+c);a(b).attr("href",d).attr("aria-pressed","false")})})},Q=function(){a(document).on("click",".snap-section-editing.actions .snap-delete",function(a){I(a,this)})},R=function(){var b=function(b,c){0===c?a("#section-"+b).addClass("hidden"):a("#section-"+b).removeClass("hidden");var d=["#section-"+(b-1),"#section-"+(b+1)],e=d.join(",");return F(e)};O("visibility",b)},S=function(){i.show(function(a){a.preventDefault(),A()})},T=function(){a("#region-main").on("click",".snap-section-editing.actions .snap-move",function(c){c.stopPropagation(),c.preventDefault(),a("body").addClass("snap-move-inprogress"),S();var d=z(this);b.debug("Section is",d);var e=a("#section-"+d),f=e.find(".sectionname").text();b.debug("Moving this section",f),o=[e],a(".section-moving").removeClass("section-moving"),e.addClass("section-moving"),a('a[href="#section-'+d+'"]').parent("li").addClass("section-moving"),a("body").addClass("snap-move-section"),n.courseConfig.partialrender&&a("#section-"+(d+1)+" .snap-drop.section-drop").removeClass("partial-render");var g=M.util.get_string("moving","theme_snap",f);i.setTitle(g),x(f)})},U=function(){"page-site-index"===document.body.id?a("#region-main .sitetopic ul.section").append('<li class="snap-drop asset-drop"><div class="asset-wrapper"><a href="#">'+M.util.get_string("movehere","theme_snap")+"</a></div></li>"):a("li.section .content ul.section").append('<li class="snap-drop asset-drop"><div class="asset-wrapper"><a href="#">'+M.util.get_string("movehere","theme_snap")+"</a></div></li>")},V=function(){a("#region-main").on("change",".js-snap-asset-move",function(c){c.stopPropagation();var d=a(this).parents(".snap-asset")[0],e=a(d).parents("ul.section")[0],f=a(e).find("li.snap-drop.asset-drop");if(a(e).append(f),0===o.length){var g=a(d).find(".snap-asset-link .instancename").html();b.debug("Moving this asset",g);var h=a(d).attr("class"),i=/(?=snap-mime)([a-z0-9\-]*)/,j=i.exec(h);h="",j&&(h=j.join(" ")),b.debug("Moving this class",h),a(d).addClass("asset-moving"),a(".snap-asset button").attr("disabled","disabled"),a(d).find("button").removeAttr("disabled"),a(".snap-asset .snap-asset-content a").attr("tabindex","-1"),a(d).find("a").removeAttr("tabindex"),a(d).find(".js-snap-asset-move").prop("checked","checked"),a("body").addClass("snap-move-inprogress"),a("body").addClass("snap-move-asset")}a(this).prop("checked")?(o.push(d),a(d).find("a").removeAttr("tabindex"),a(d).find("button").removeAttr("disabled"),a(d).addClass("asset-moving")):(C(d),a(d).find(".snap-asset-content a").attr("tabindex","-1"),a(d).find("button").attr("disabled","disabled"),a(d).removeClass("asset-moving"),0===o.length&&A()),S(),w()})},W=function(){a(document).on("click",".snap-move-note, .snap-drop",function(c){if(b.debug("Snap drop clicked",c),o)if(c.stopPropagation(),c.preventDefault(),a("body").hasClass("snap-move-section"))L(this);else{var d;d=a(this).hasClass("snap-drop")?this:a(this).closest(".snap-asset"),K(d)}})},X=function(){t(),u()},Y=function(){T(),R(),P(),Q(),V(),W(),N(),U(),j.courseConfig.partialrender&&X(),a("body").addClass("snap-course-listening")},Z=function(){M.course&&M.course.resource_toolbox&&(M.course.resource_toolbox.handle_resource_dim=function(a,b,c){return"hide"===c?0:1})},$=function(){Y(),g.whenTrue(function(){return M.course&&M.course.init_section_toolbox},function(){Z()},!0)};$()},renderAndFocusSection:function(a,b){y(a,b)},setTocObserver:function(){t()}}});