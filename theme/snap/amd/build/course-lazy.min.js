define(["jquery","theme_snap/util","theme_snap/section_asset_management","theme_snap/course_modules"],function(a,b,c,d){return function(e){var f=this;f.courseConfig=e;var g=function(){return 0===a("body").attr("id").indexOf("page-course-view-")},h=function(c){a("#toc-search-results").html("");var d=a("#"+c.replace("#",""));b.scrollToElement(d);var e=a("#searchpin");e.length||(e=a('<i id="searchpin"></i>')),a(d).find(".instancename").prepend(e),a(d).attr("tabindex","-1").focus(),a("#course-toc").removeClass("state-visible")};this.setTOCVisibleSection=function(){var b=".section.main.state-visible, #coursetools.state-visible, #snap-add-new-section.state-visible",c=a(b).attr("id");a("#chapters li").removeClass("snap-visible-section"),a('#chapters a[href$="'+c+'"]').parent("li").addClass("snap-visible-section"),a(document).trigger("snapContentRevealed")},this.showSection=function(){if(g()){var b="";a(".section.main.state-visible.set-by-server").length?(b="#"+a(".section.main.state-visible.set-by-server").attr("id"),a(".section.main.state-visible.set-by-server").removeClass("set-by-server")):a(".course-content .section.main, #moodle-blocks,#coursetools, #snap-add-new-section").removeClass("state-visible");var c=location.hash.split("&"),d=c[0],e=c[1]||null;if(""==d){var f=location.search.substring(1),j=f.split("&");j.forEach(function(a){a.indexOf("section=")>=0&&(a.replace(a),d="#"+a.replace("=","-"))})}""!==d&&d!==b&&a(b).removeClass("state-visible"),"#coursetools"==d&&a("#moodle-blocks").addClass("state-visible"),null!==e?(a(d).addClass("state-visible"),h(e)):(a(d).addClass("state-visible").focus(),i());var k=a(".section.main.state-visible,#coursetools.state-visible,#snap-add-new-section.state-visible");k.length||(a(".section.main.current").length?a(".section.main.current").addClass("state-visible").focus():a("#section-0").addClass("state-visible").focus(),i()),a("li.snap-activity:visible, li.snap-resource:visible").on("click","a.mod-link",function(){sessionStorage.setItem("lastMod",a(this).parents("[id^=module]").attr("id"))}),this.setTOCVisibleSection()}};var i=function(){var c=sessionStorage.getItem("lastMod");null===c?window.scrollTo(0,0):(b.scrollToElement(a("#"+c)),sessionStorage.removeItem("lastMod"))},j=function(){var b=a(location).attr("hash"),d=b.replace("#","").split("&"),e=!1,f=0;if(a.each(d,function(a,b){b.indexOf("section")!=-1?e=b.split("section-")[1]:b.indexOf("module")!=-1&&(f=b.split("module-")[1])}),!e){var g=location.search.substring(1),h=g.split("&");h.forEach(function(a){a.indexOf("section=")>=0&&(a.replace(a),e=a.replace("section=",""))})}e&&a('.chapters .chapter-title[href="#section-'+e+'"]').length>0&&c.renderAndFocusSection(e,f)},k=function(){if(c.init(f),d.init(),f.courseConfig.enablecompletion&&require(["theme_snap/course_conditionals-lazy"],function(a){a(e)}),g()&&(f.showSection(),a(document).on("snapTOCReplaced",function(){f.setTOCVisibleSection(),f.courseConfig.partialrender&&c.setTocObserver()}),f.courseConfig.partialrender)){j(),a(window).on("hashchange",function(){j()});var b=a('.course-content li[id^="section-"]'),h=location.hash.split("&"),i=h[0];if(1==b.length&&"#coursetools"!=i){b.addClass("state-visible");var k=b.attr("id").split("section-")[1];if("top"==f.courseConfig.toctype&&"topics"==f.courseConfig.format&&k>0){var l=b.find(".sectionname").text(),m=a(".chapter-title"),n=0;a.each(m,function(b,c){a(c).attr("section-number")==k&&(n=b)}),b.find(".sectionname").text(n+". "+l)}}}},l=function(){a(".section-modchooser-link").click(function(){var b=a(this).attr("data-section");a(".snap-modchooser-addlink").each(function(){var c=this.href.replace(/(section=)[0-9]+/gi,"$1"+b);a(this).attr("href",c)})})};k(),l()}});