define(["jquery","core/log","core/yui","theme_snap/pm_course_cards","theme_snap/util","theme_snap/ajax_notification"],function(a,b,c,d,e,f){var g=function(){var c=this,g=!1;this.update=function(){if(g){var c=M.cfg.wwwroot+"/user/policy.php";return void(window.location=c)}d.reqCourseInfo(d.getCourseIds()),a("#snap-pm").focus();var h=function(c){var d=a("#snap-personal-menu-"+c);if(a(d).length){var g=M.cfg.sesskey+"personal-menu-"+c;try{if(e.supportsSessionStorage()&&window.sessionStorage[g]){b.info("using locally stored "+c);var h=window.sessionStorage[g];a(d).html(h)}b.info("fetching "+c),a.ajax({type:"GET",async:!0,url:M.cfg.wwwroot+"/theme/snap/rest.php?action=get_"+c+"&contextid="+M.cfg.context,success:function(h){f.ifErrorShowBestMsg(h).done(function(f){f||(b.info("fetched "+c),e.supportsSessionStorage()&&"undefined"!=typeof h.html&&(window.sessionStorage[g]=h.html),a(d).attr("data-content-loaded","1"),a(d).html(h.html))})}})}catch(i){sessionStorage.clear(),b.error(i)}}};h("deadlines"),h("graded"),h("grading"),h("messages"),h("forumposts"),a(document).trigger("snapUpdatePersonalMenu");try{document.dispatchEvent(new Event("snapPersonalMenuOpen"))}catch(i){b.error(i.message);try{var j=document.createEvent("Event");j.initEvent("snapPersonalMenuOpen",!0,!0),document.dispatchEvent(j)}catch(k){b.error(k.message)}}};var h=function(){var b=function(b){var c=a("#snap-pm-content section"),d=a(c).outerWidth(),e=a(b),f="#snap-pm-updates section > div, #snap-pm-updates section > snap-feed > div",g=a(f).index(e)+1,h=d*g,i=a(b).outerHeight()+200;"#snap-pm-courses"==b&&(h=0);var j=a(window).height();return i<j&&(i=j),{left:h,height:i}};a(window).on("resize",function(){if(window.innerWidth>=992){if(a("#snap-pm-content").removeAttr("style"),a("#snap-pm-courses div#snap-personal-menu-intelliboard").length>0){var c=a("div#snap-personal-menu-intelliboard").closest("section");c.prependTo("#snap-pm-updates")}if(a("#snap-pm-courses div#snap-personal-menu-intellicart").length>0){var c=a("div#snap-personal-menu-intellicart").closest("section");c.prependTo("#snap-pm-updates")}}else{var d=a("#snap-pm-mobilemenu a.state-active");if(d&&d.length){if(a("#snap-pm-updates div#snap-personal-menu-intelliboard").length>0){var c=a("div#snap-personal-menu-intelliboard").closest("section");c.appendTo("section#snap-pm-courses")}if(a("#snap-pm-updates div#snap-personal-menu-intellicart").length>0){var c=a("div#snap-personal-menu-intellicart").closest("section");c.appendTo("section#snap-pm-courses")}var e=d.attr("href"),f=b(e);a("#snap-pm-content").css("left","-"+f.left+"px"),a("#snap-pm-content").css("height",f.height+"px")}}}),a(document).on("click","#snap-pm-mobilemenu a",function(c){var d=this.getAttribute("href"),e=b(d);a("html, body").animate({scrollTop:0},0),a("#snap-pm-content").animate({left:"-"+e.left+"px",height:e.height+"px"},"700","swing",function(){}),a("#snap-pm-mobilemenu a").removeClass("state-active"),a(this).addClass("state-active"),c.preventDefault()})},i=function(){a(document).on("click",".js-snap-pm-trigger",function(b){if(a("html, body").animate({scrollTop:0},0),a("body").toggleClass("snap-pm-open"),a(".snap-pm-open #snap-pm").is(":visible")&&c.update(),b.preventDefault(),window.innerWidth<992){if(a("#snap-pm-updates div#snap-personal-menu-intelliboard").length>0){var d=a("div#snap-personal-menu-intelliboard").closest("section");d.appendTo("section#snap-pm-courses")}if(a("#snap-pm-updates div#snap-personal-menu-intellicart").length>0){var d=a("div#snap-personal-menu-intellicart").closest("section");d.appendTo("section#snap-pm-courses")}}0===a(".message-app.main").length&&document.dispatchEvent(new Event("messages-drawer:pm-toggle"))}),h()};this.init=function(a){g=a,i(),g||d.init()}};return new g});